<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>VDA 5050 3D äº’å‹•æ•™å­¸</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; }
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; }
        
        /* å·¦å´ï¼šä¸»æ§ç«¯æ“ä½œ */
        #master-panel {
            width: 300px; background: rgba(0, 60, 100, 0.8); padding: 20px; pointer-events: auto;
            border-right: 1px solid #00aaff; display: flex; flex-direction: column; gap: 10px;
        }
        h2 { margin: 0 0 10px 0; font-size: 18px; color: #00aaff; border-bottom: 1px solid #00aaff; padding-bottom: 5px;}
        h3 { margin: 0; font-size: 16px; color: #00ff88; }
        
        button {
            background: #00aaff; border: none; color: white; padding: 10px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        button:hover { background: #0088cc; }
        button:disabled { background: #555; cursor: not-allowed; }

        /* å³å´ï¼šè³‡æ–™æµèˆ‡ AGV ç‹€æ…‹ */
        #data-panel {
            position: absolute; right: 0; top: 0; width: 350px; height: 100%; 
            background: rgba(0, 0, 0, 0.85); padding: 20px; pointer-events: auto;
            overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px;
            border-left: 1px solid #444;
        }

        .json-block { background: #222; padding: 10px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #444; }
        .key { color: #9cdcfe; }
        .string { color: #ce9178; }
        .number { color: #b5cea8; }
        
        /* ä¸­é–“æç¤º */
        #tooltip {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px;
            font-size: 14px; color: #aaa;
        }

        /* æ¨™ç±¤ */
        .label {
            position: absolute; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 3px; 
            font-size: 10px; pointer-events: none;
        }
    </style>
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- å¼•å…¥ Tween.js ç”¨æ–¼å‹•ç•« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="ui-container">
        <div id="master-panel">
            <h2>Master Control (ä¸»æ§ç«¯)</h2>
            <p style="font-size:12px; color:#ccc;">æ¨¡æ“¬ç™¼é€ VDA 5050 "Order" topic</p>
            
            <button id="btn-order-1" onclick="sendOrder('path1')">ğŸ“¦ ä»»å‹™ Aï¼šå‰å¾€å€‰åº«å–è²¨</button>
            <button id="btn-order-2" onclick="sendOrder('path2')">ğŸ­ ä»»å‹™ Bï¼šé‹é€è‡³ç”¢ç·š</button>
            <button id="btn-pause" onclick="togglePause()" style="background:#ffaa00;">II æš«åœ/æ¢å¾© (Instant Action)</button>
            
            <div style="margin-top: auto;">
                <h3>æ¨¡æ“¬èªªæ˜ï¼š</h3>
                <p style="font-size:12px; color:#ccc;">
                    1. é»æ“ŠæŒ‰éˆ•ç™¼é€ Order JSONã€‚<br>
                    2. ç¶ è‰²æ–¹å¡Š (AGV) è§£æ Nodes/Edgesã€‚<br>
                    3. AGV ç§»å‹•ä¸¦æŒçºŒå›å ± State JSONã€‚<br>
                    4. è§€å¯Ÿå³å´é¢æ¿çš„æ•¸æ“šè®ŠåŒ–ã€‚
                </p>
            </div>
        </div>

        <div id="data-panel">
            <h2>Topic Monitor (é€šè¨Šç›£æ§)</h2>
            
            <h3>â¬‡ï¸ Received Order (Topic: order)</h3>
            <div id="json-order" class="json-block">ç­‰å¾…æŒ‡ä»¤...</div>

            <h3>â¬†ï¸ AGV State (Topic: state)</h3>
            <div id="json-state" class="json-block">åˆå§‹åŒ–ä¸­...</div>
        </div>
    </div>

    <div id="tooltip">æŒ‰ä½æ»‘é¼ å·¦éµæ—‹è½‰è¦–è§’ â€¢ æ»¾è¼ªç¸®æ”¾</div>

    <script>
        // --- 1. 3D å ´æ™¯è¨­å®š (Three.js) ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 15);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ç‡ˆå…‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);

        // åœ°æ¿ç¶²æ ¼
        const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x333333);
        scene.add(gridHelper);

        // --- 2. ç‰©ä»¶å»ºç«‹ ---
        
        // AGV (ç¶ è‰²æ–¹å¡Š)
        const agvGeometry = new THREE.BoxGeometry(0.8, 0.5, 1.2);
        const agvMaterial = new THREE.MeshLambertMaterial({ color: 0x00ff88 });
        const agv = new THREE.Mesh(agvGeometry, agvMaterial);
        agv.position.set(0, 0.25, 0);
        scene.add(agv);

        // ç¯€é» (Nodes) è¦–è¦ºåŒ–
        const nodes = {
            "start": { x: 0, z: 0 },
            "n1": { x: 0, z: -5 },
            "n2": { x: 5, z: -5 },
            "n3": { x: 5, z: 5 },
            "n4": { x: -5, z: 5 },
            "n5": { x: -5, z: 0 }
        };

        // ç¹ªè£½ç¯€é»èˆ‡æ¨™ç±¤
        Object.keys(nodes).forEach(key => {
            const node = nodes[key];
            const sphere = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({ color: 0x00aaff }));
            sphere.position.set(node.x, 0, node.z);
            scene.add(sphere);
            
            // ç°¡å–®çš„åœ°é¢æ–‡å­— (ç”¨ Canvas è²¼åœ–)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 128; canvas.height = 64;
            ctx.fillStyle = 'white';
            ctx.font = '40px Arial';
            ctx.fillText(key, 10, 50);
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
            sprite.position.set(node.x, 1, node.z);
            sprite.scale.set(2, 1, 1);
            scene.add(sprite);
        });

        // --- 3. VDA 5050 é‚è¼¯æ¨¡æ“¬ ---

        // æ¨¡æ“¬è³‡æ–™çµæ§‹
        let agvState = {
            headerId: 0,
            timestamp: new Date().toISOString(),
            version: "2.0.0",
            manufacturer: "SimBot",
            serialNumber: "AGV-001",
            orderId: "",
            orderUpdateId: 0,
            lastNodeId: "start",
            lastNodeSequenceId: 0,
            driving: false,
            batteryState: { batteryCharge: 80.5, charging: false },
            errors: []
        };

        let currentTween = null;
        let isPaused = false;

        // å®šç¾©è·¯å¾‘ (VDA 5050 Order çµæ§‹ç°¡åŒ–ç‰ˆ)
        const paths = {
            "path1": {
                orderId: "ORD-2023-001",
                nodes: [
                    { nodeId: "start", sequenceId: 0, released: true },
                    { nodeId: "n1", sequenceId: 1, released: true },
                    { nodeId: "n2", sequenceId: 2, released: true }
                ],
                edges: [
                    { edgeId: "e1", sequenceId: 1, startNodeId: "start", endNodeId: "n1", maxSpeed: 1.0 },
                    { edgeId: "e2", sequenceId: 2, startNodeId: "n1", endNodeId: "n2", maxSpeed: 1.0 }
                ]
            },
            "path2": {
                orderId: "ORD-2023-002",
                nodes: [
                    { nodeId: "n2", sequenceId: 2, released: true },
                    { nodeId: "n3", sequenceId: 3, released: true },
                    { nodeId: "n4", sequenceId: 4, released: true },
                    { nodeId: "start", sequenceId: 5, released: true }
                ],
                edges: [
                    { edgeId: "e3", sequenceId: 3, startNodeId: "n2", endNodeId: "n3", maxSpeed: 1.5 },
                    { edgeId: "e4", sequenceId: 4, startNodeId: "n3", endNodeId: "n4", maxSpeed: 1.5 },
                    { edgeId: "e5", sequenceId: 5, startNodeId: "n4", endNodeId: "start", maxSpeed: 0.8 }
                ]
            }
        };

        // æ›´æ–° UI é¡¯ç¤º JSON
        function updateUI() {
            const stateEl = document.getElementById('json-state');
            agvState.timestamp = new Date().toISOString();
            agvState.headerId++;
            
            // æ ¼å¼åŒ– JSON é¡¯ç¤º (ç°¡æ˜“èªæ³•é«˜äº®)
            const jsonStr = JSON.stringify(agvState, null, 2);
            stateEl.innerHTML = syntaxHighlight(jsonStr);
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'string'; // bool as string color for simplicity
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // ç™¼é€è¨‚å–®
        function sendOrder(pathKey) {
            if (agvState.driving) {
                alert("AGV å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œï¼ˆVDA 5050 æ”¯æ´ Order Updateï¼Œä½†æ­¤ Demo åƒ…ç¤ºç¯„å–®ä¸€ä»»å‹™ï¼‰ã€‚");
                return;
            }

            const order = paths[pathKey];
            
            // æª¢æŸ¥èµ·å§‹é»æ˜¯å¦åŒ¹é…
            if (order.nodes[0].nodeId !== agvState.lastNodeId) {
                alert(`è·¯å¾‘ä¸åŒ¹é…ï¼ AGV ç›®å‰åœ¨ ${agvState.lastNodeId}ï¼Œä½†è¨‚å–®å¾ ${order.nodes[0].nodeId} é–‹å§‹ã€‚è«‹å…ˆåŸ·è¡Œå…¶ä»–ä»»å‹™å›åˆ°æ­£ç¢ºä½ç½®ã€‚`);
                return;
            }

            // é¡¯ç¤º Order JSON
            document.getElementById('json-order').innerHTML = syntaxHighlight(JSON.stringify(order, null, 2));
            
            // æ›´æ–° AGV ç‹€æ…‹
            agvState.orderId = order.orderId;
            agvState.driving = true;
            
            executePath(order, 0);
        }

        // éè¿´åŸ·è¡Œè·¯å¾‘ç§»å‹•
        function executePath(order, stepIndex) {
            if (stepIndex >= order.edges.length) {
                agvState.driving = false;
                updateUI();
                return;
            }

            const edge = order.edges[stepIndex];
            const targetNodeId = edge.endNodeId;
            const targetPos = nodes[targetNodeId];
            const startPos = nodes[edge.startNodeId];

            // è¨ˆç®—è·é›¢èˆ‡æ™‚é–“ (æ¨¡æ“¬é€Ÿåº¦)
            const dist = Math.sqrt(Math.pow(targetPos.x - startPos.x, 2) + Math.pow(targetPos.z - startPos.z, 2));
            const duration = (dist / edge.maxSpeed) * 1000;

            // è½‰å‘
            agv.lookAt(targetPos.x, 0.25, targetPos.z);

            // ç§»å‹•å‹•ç•«
            currentTween = new TWEEN.Tween(agv.position)
                .to({ x: targetPos.x, z: targetPos.z }, duration)
                .easing(TWEEN.Easing.Linear.None)
                .onUpdate(() => {
                    // å³æ™‚æ›´æ–° State ä½ç½® (æ¨¡æ“¬)
                    // å¯¦éš› VDA 5050 æœƒæœ‰ x, y, theta
                    updateUI();
                })
                .onComplete(() => {
                    agvState.lastNodeId = targetNodeId;
                    agvState.lastNodeSequenceId = order.nodes[stepIndex + 1].sequenceId;
                    updateUI();
                    executePath(order, stepIndex + 1);
                })
                .start();
        }

        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                if(currentTween) currentTween.pause();
                agvState.errors = [{ errorType: "pause", errorDescription: "User paused by Instant Action" }];
            } else {
                if(currentTween) currentTween.resume();
                agvState.errors = [];
            }
            updateUI();
        }

        // --- 4. æ¸²æŸ“è¿´åœˆ ---
        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);
            renderer.render(scene, camera);
        }
        
        // åˆå§‹æ›´æ–°
        updateUI();
        animate();

        // è¦–çª—èª¿æ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
